### 树的直径

给定一颗 $n$ 个节点的无根树 $T$，树上每条边 $(u,v)$ 有非负边权 $w(u,v)$，这颗树的边集记作 $E$，点集记作 $V$，以下讨论均在这一框架下进行。



**定义1**

若树上一条路径 $P(u,v)$ 使得 $u$ 到 $v$ 的距离 $dis(u,v)$ 最长，则称 $P$ 为这颗树的直径，这颗树的直径长度记作 $D(T)$。

同一颗树的直径长度是唯一的，但作为直径的路径却不是唯一的。



**定理1** 

对于直径 $P(u,v)$，端点 $u$ 和 $v$ 必然是树的叶子节点。

**证明**

考虑到边权非负，如果**定理1**不然则可找到更长的路径，与直径的定义矛盾。



**定义2** 

任取 $V$ 的非空子集 $S$，子集 $S$ 中的点可以不是连通块。定义 $S$ 上的一条路径 $P_S(u,v)$，满足 $u,v\in S$。$P_S(u,v)$ 里的节点可以在 $S$ 之外，但仍然在 $V$ 内。



**定义3** 

非空节点子集 $S$ 的直径定义为 $S$ 上的一条路径 $P_S(u,v)$，满足 $P_S(u,v)$ 的长度最长。



**定理2** 

任取非空节点子集 $S\sube V$，设 $P_S(u,v)$ 为 $S$ 的直径，任取节点 $x\in V$（$x$ 可以属于 $S$），则 $x$ 与 $S$ 中的节点们的最长距离一定是 $dis(x,u)$ 或 $dis(x,v)$，也即 $x$ 到 $S$ 的最长路径可以由路径 $P(x,u)$ 或路径 $P(x,v)$ 产生。

**证明**

若 $\exists y\in S-\{u\}-\{v\}$，使得 $dis(x,y)>\max\{dis(x,u),dis(x,v)\}$，根据**定理1**可以证明
$$
\max\{dis(u,y),dis(v,y)\}>dis(u,v)
$$
所以 $P_S(u,v)$ 不是 $S$ 上的直径，矛盾，故**定理2**成立。



**定理3** 

任取 $V$ 上的两个不交的非空子集 $S_1$ 和 $S_2$，设 $P_{S_1}(u_1,v_1)$ 是 $S_1$ 上的直径， $P_{S_2}(u_2,v_2)$ 是 $S_2$ 上的直径，再令 $S=S_1\cup S_2$，$P_S(u,v)$ 是 $S$ 上的直径，则
$$
dis(u,v)=\max\{dis(u_1,v_1),dis(u_1,v_2),dis(u_2,v_1),dis(u_2,v_2)\}
$$
说明并集直径的端点一定可以由子集直径的端点产生。

**证明**

任取 $S$ 上的点对 $(x,y)$。

若 $x,y$ 同时属于 $S_1$ 或 $S_2$，显然有 $dis(x,y)\le\max\{dis(u_1,v_1),dis(u_2,v_2)\}$。

所以只用考虑 $x$ 与 $y$ 不属于同一子集的情况，不妨设 $x\in S_1,\ y\in S_2$。

其次，由**定理2**知
$$
dis(x,y)\le\max\{dis(x,u_2),dis(x,v_2)\}\\
dis(x,u_2)\le\max\{dis(u_1,u_2),dis(v_1,u_2)\}\\
dis(x,v_2)\le\max\{dis(u_1,v_2),dis(v_1,v_2)\}\\
$$
所以有
$$
dis(x,y)\le\max\{dis(u_1,v_1),dis(u_1,v_2),dis(u_2,v_1),dis(u_2,v_2)\}
$$
故知**定理3**成立。



**定理4** 

在**定理3**中关于 $S_1$ 与 $S_2$ 不交的条件可以去掉，即 $S_1$ 与 $S_2$ 可以存在交点，但**定理3**的结论仍然成立。

**证明**

若 $S_1\cap S_2\neq \empty$，取 $S_3=S_1\cap S_2,\ S_1^\prime=S_1-S_3,\ S_2^\prime=S_2-S_3$，则 $S_1^\prime,S_2^\prime,S_3$ 三者不交，由**定理3**可证**定理4**成立。



**定理5**

任选一个树中的节点作为根 $rt$，求出树中某节点 $u$ 使得 $dis(rt, u)$ 最大，再将 $u$ 作为根求出树中某节点 $v$ 使得 $dis(u,v)$，则路径 $P(u,v)$ 是树的直径。

**证明**

任选点对 $(x,y)$ 可以通过反证法证明若路径 $P(x,y)$ 与 $P(rt, u)$ 不相交，则 $dis(x,y)\le dis(rt,u)$。

所以一定存在与 $P(rt,u)$ 相交的树的直径。

不妨设直径 $P(x,y)$ 与 $P(rt, u)$ 相交，则相交的部分一定是一条路径 $P(s, t)$，不妨设 $x$ 与 $s$ 更接近，$y$ 与 $t$ 更接近。

由 $u$ 的定义知
$$
dis(rt,t)+dis(t,y)=dis(rt,y)\le dis(rt,u)=dis(rt,t)+dis(t,u)
$$
所以有
$$
dis(t,y)\le dis(t,u)
$$
于是
$$
dis(x,y)=dis(x,s)+dis(s,t)+dis(t,y)\le dis(x,t)+dis(s,t)+dis(t,u)=dis(x,u)
$$
取 $v=x$ 知**定理5**成立。



### 例题

$(1)$

给定两颗结构不同的树 $T_1,T_2$，它们的边权均为负，定义路径 $P(u,v)$ 的权值 $we(P(u,v))=T_1.dis(u,v)+T_2.dis(u,v)$，要求设计一个 $O(n)$ 的算法求出权值最大的路径的权值。

**解**

在第一颗树上 $\text{dp}$，设 $f(u)=(x,y)$ 表示 $T_1$ 中子树 $u$











