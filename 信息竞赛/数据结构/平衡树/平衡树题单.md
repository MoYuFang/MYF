平衡树往往码量大，调试难，故能不用平衡树就不要用平衡树，但的确有一些题是平衡树能做到的而其它数据结构做不到的。

**带插入全序集维护**

**题意** : 维护一个序列，支持（在指定元素后面）插入元素，询问两个元素的先后顺序。

显然可以使用平衡树维护，回答询问时，求出两者的排名并比较。这样能做到 $O(\log n)$ 修改 $O(\log n)$ 查询。

考虑给每个元素一个标号，是的先后顺序和标号的大小顺序相对应。

给根一个值域区间，如 $[0,1]$ 或 $[0,2^{60}-1]$，将点 $u$ 的权值设为自己区间的中点 $mid=(u.l+u.r)/2$，并令左右儿子的值域区间分别为 $[u.l,mid]$，$[mid,u.r]$。

显然，这样得到的权值也满足左小右大的性质。若平衡树的最大高度为 $h$ ，则权值精度要求是 $O(2^h)$ 的。

使用重量平衡树（如 $\text{Treap}$）来维护这个序列，这样能够保证我们每次操作更新（并重新标记权值）的子树大小是 $O(\log n)$ 级别的。

使用 `double` 或 `long long` 即可满足。

比较先后顺序时，只需比较标号即可，这样即可做到（均摊）$O(\log n)$ 修改 $O(1)$ 查询。

#### 题单

[P6136 【模板】普通平衡树（数据加强版） ](https://www.luogu.com.cn/problem/P6136)

[P3391 【模板】文艺平衡树](https://www.luogu.com.cn/problem/P3391)

[P3960 [NOIP2017 提高组] 列队](https://www.luogu.com.cn/problem/P3960)

[P7815 「小窝 R3」自傷無色](https://www.luogu.com.cn/problem/P7815) $\text{dsu on tree}$ + 全局平衡树维护平方和

[CF1578B Building Forest Trails](https:\\www.luogu.com.cn\problem\CF1578B)