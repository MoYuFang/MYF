![oiclass P3685 Cicada 拿衣服](..\..\..\题面\oiclass P3685 Cicada 拿衣服.png)

直接对整个数组进行计算十分困难，考虑对每个数值分别进行计算，最后加上偏移量即可。

不妨设现在计算的数值是 $x$​​，我们模拟 $merge$​​ 的过程，然后在每一层计算出每一个位置 $i$​​ 上出现第 $k$​ 个数的概率。

设当前层对应的区间为 $[tl,tr]$​​​​，且设当前层一共有 $c$​​​​ 个元素 $x$​​​​，再设 $h(i,k)$​​​​ 表示当前层第 $i$​​​​ 个位置上出现的是第 $k$​​​​ 个数的概率，则必有 $\sum_{i=1}^{c}h(i,k)=1$​​​​ 且 $\sum_{k=1}^{c}h(i,k)=1$​​​​，分别对应于第 $k$​​​​ 个数字一定在某个位置上出现和第 $i$​​​​ 个位置上一定有某个数字出现，这个可以用来 ```assert``` 检验。

然后设左子区间 $[tl,mi]$​​​ 的计算结果是 $f(i,k)$​​​ ，一共有 $a$​​​ 个 $x$​​​，右子区间 $[mi+1,tr]$​​​ 的计算结果是 $g(j,l)$​​​​ ，一共有 $b$​​​ 个 $x$​​​​，我们用这两个子区间的结果去计算大区间的结果。

考虑现在的局面是左子区间的元素已经用了前 $i-1$​ 个，右子区间的元素已经用了前 $j-1$​ ，且左右区间都还没用完（即 $1\leq i\leq a,1\leq j \leq b$​），下一步决策就是下一个位置分配给左右哪一个区间前头的数，于是做两种转移。

下一个位置分配给左区间时的转移：

枚举左区间第 $i$ 个位置上是第几个元素（设为第 $k$ 个）：
$$
h(i+j-1,k)=h(i+j-1,k) + f(i,k)\cdot (\frac{1}{2})^{i+j-1}\cdot C_{i+j-2}^{i-1}
$$
其中 $(\frac{1}{2})^{i+j-2}\cdot C_{i+j-2}^{i-1}$ 代表了达到这种局面的概率，而多乘了个 $\frac{1}{2}$ 代表了下一个位置分配给左区间时的概率。

下一个位置分配给右区间时的转移类似：

枚举右区间第 $j$ 个位置上是第 $l$ 个元素：
$$
h(i+j-1,a+l)=h(i+j-1,a+l)+g(j,l)\cdot (\frac{1}{2})^{i+j-1}\cdot C_{i+j-2}^{i-1}
$$
其中 $a+l$ 是因为右区间的第 $l$ 个元素从当前层看来是第 $a+l$ 个元素。

除了左右区间都还没用完的情况还要考虑左右区间其中一方用完了的情况。

设现在的局面是左子区间的元素已经用了前 $i-1$​ 个元素且左区间还没用完，但右区间已经用完了（即 $j=b+1$）。

转移式有些难写，不妨先考虑达成这样的局面的概率有多少。

设达成其中一区间已经用完，且用完的区间一共有 $y$ 个元素，另一区间只用了前 $i-1$ 个元素且没用完的局面的概率为 $q(i,y)$，其中 $1\leq i \leq n,0\leq y \leq n$ 。

达成这种局面有两种情况，要么上一个位置分配给的是已用完区间的元素，分配完后才用完，这样的概率为$ (\frac{1}{2})^{i+j-1}\cdot C_{i+j-2}^{i-1}$​ ，要么上一位置分配给的是未用完的区间的元素，这样的概率是 $q(i-1,y)$​ ，于是有转移式：
$$
q(i,y)=q(i-1,y)+(\frac{1}{2})^{i+y-1}\cdot C_{i+y-2}^{i-1}
$$
边界条件是 $q(i,0)=1$。

考虑到某个式子反复出现，于是我们使用下面表示来简化：
$$
p(i,j) =(\frac{1}{2})^{i+j-1}\cdot C_{i+j-2}^{i-1}
$$
于是有：
$$
q(i,y) = q(i-1,y)+p(i,y)
$$
再来考虑这种局面时的转移（左子区间的元素已经用了前 $i-1$ 个元素且左区间还没用完，右区间已经用完了）：

枚举左区间第 $i$ 个位置上是第 $k$ 个元素：
$$
h(b+i,k)=h(b+i,k)+f(i,k)\cdot q(i,b)
$$
左区间用完，右区间用了前 $j-1$ 个元素且没用完的局面同理：

枚举右区间第 $j$ 个位置上是第 $l$ 个元素：
$$
h(a+j,a+l)=h(a+j,a+l)+g(j,l)\cdot q(j,a)
$$
于是当前层的 $\text{dp}$​ 就完成了。

最后别忘了在计算完整个区间的 $h(i,k)$ 后还要利用它去计算期望。

时间复杂度与数据相关性较大，设给出的数据中有 $y$ 种元素，每种元素有 $sz(x)$ 个，则对于每种元素进行 $\text{dp}$ 的复杂度是：
$$
sz(x)^3\log n
$$
总复杂度是 $O(\sum sz(x)^3\log n)=O(n^3 \log n)$。 

注意事项：

1. 在模拟 $merge$ 的过程中注意，不要直接在当前层开数组 $f$ 和 $g$ ，会爆栈，可以先在全局空间中开一个三维数组，开数组 $f$ 和 $g$​​ 相当于给它们各自分配一个二维数组，即：```(*f)[maxn] = tmp[top++]```。
2. $p(i,j)$ 与 $q(i,y)$ 可以提前以 $O(n^2)$ 预处理。



