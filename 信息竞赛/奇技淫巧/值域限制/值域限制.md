有一些数据结构问题形如：给定 $n$ 个数，每次询问给定 $[l,r]$ 和 $[L,R]$，要求将区间 $[l,r]$ 里值域在 $[L,R]$ 内的数取出来然后做一些统计。

这类问题的典型特征是在原有区间限制 $[l,r]$ 的基础上对值域也做了限制，有些问题将值域为 $[L,R]$ 的限制放宽为 $\le x$ 或 $\ge x$，也带来了更简便的做法。

这类问题的处理方法大致有两种，以下略做总结。

$(1)$

值域限制 $[L,R]$ 也是一个区间，离散化后规模同原问题同阶。

可任选两个区间其中一个固定，常见的有用莫队或枚举区间右端点，然后回答在另一个区间限制下的答案。

经典的问题就是区间求元素排名，这个用莫队+分块可以做到 $O(n\sqrt{n})$，或者用主席树做到 $O(n\log n)$。

这种做法不是本文的主要讨论方向。

$(2)$

**区间型值域限制**

维护线段树，在线段树的每个节点上维护每种值域限制的答案，回答查询时先根据 $[l,r]$ 取出 $O(\log n)$ 个节点，取出这些节点记录的关于值域 $[L,R]$ 的信息，再将这些信息合并得到最终答案。

因为本质不同的值域数量为 $O(n^2)$，所以需要配以分块等数据结构降低复杂度。

[P5611 [Ynoi2013] D2T2](https://www.luogu.com.cn/problem/P5611) 

[P7290 「EZEC-5」暴力出奇迹](https://www.luogu.com.cn/problem/P7290) 

[省选计划模拟赛14 T2]()

**前/后缀型值域限制**

若关于值域的限制只有一维，即值域是 $\le x$ 或 $\ge x$，则本质不同的值域数量为 $O(n)$，这时候就不需要分块了。

[P7707 「Wdsr-2.7」百花齐放的太阳花田](https://www.luogu.com.cn/problem/P7707) 























