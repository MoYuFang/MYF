[[WC2017模拟1.22] 简单题](..\..\题面\[WC2017模拟1.22] 简单题.png) 

[P3349 [ZJOI2016]小星星](https://www.luogu.com.cn/problem/P3349) 先树形 $\text{dp}$​ 再容斥优化，该题的容斥有两种方向，一是对树的边进行容斥，而是对树的点进行容斥，前者靠状压和子集枚举处理排列，只能做到 $O(n^23^n)$，后者靠容斥去掉排列的限制，可做到 $O(n^32^n)$。

[P5376 [THUPC2019]过河卒二](https://www.lugu.com.cn/problem/P5376) 用 $\text{dp}$​ 优化容斥式

[P6651 「SWTR-05」Chain](https://www.lugu.com.cn/problem/P6651) 同上一题类似

[P6662 [POI 2019] Przedszkole](https://www.luogu.com.cn/problem/P6662) 可撤销并查集+容斥+状压dp

[oiclass P3955 记录数列](..\..\题面\oiclass P3955 记录数列.png) 根据阶梯数组可以分 $m$ 段，需将 $n$ 个数字分成连续的 $m$ 份，分给 $m$ 段。$m$ 段之间有 $m-1$ 个空隙，第 $i$ 个空隙对应一个性质 $A_i$ 代表第 $i$ 段与第 $i+1$ 段不能缝合称连续段。则答案为 $P(\cap_{i=1}^{m-1}A_i)$。直接计算很复杂，考虑容斥。计算分两步，第一步确定 $m$ 段的分割方案，区别两个不同方案要考虑的因素是，被缝合的空隙的出现位置，以及缝合好后得到的新 $m-j$ 段中每个长度大于等于 $2$ 的段是否翻转（长度为 $1$ 翻转后并不使方案改变） ，第二步是给将 $n$ 个数字分配给 $m-j$ 段。

为计算第一步，设 $f_{i,j,0/1}$ 表示前 $i$ 段中缝合了 $j$ 个空隙且第 $i$ 段的长度是否大于 $1$ 的方案数，$r_i$ 表示第 $i$ 段的长度$(1\le i\le m)$，转移为

当 $r_i=1$ 时
$$
\begin{gather}
f_{i,j,0}+=f_{i-1,j,0}+2f_{i-1,j,1}\\
f_{i,j,1}+=f_{i-1,j-1,0}+f_{i-1,j-1,1}\\
\end{gather}
$$
当 $r_i\ge2$ 时
$$
\begin{gather}
f_{i,j,1}+=f_{i-1,j,0}+2f_{i-1,j,1}\\
f_{i,j,1}+=f_{i-1,j-1,0}+f_{i-1,j-1,1}\\
\end{gather}
$$
于是缝合了 $j$ 个空隙的分割方案数是 $s_j=f_{m,j,0}+2f_{m,j,1}$。

注意在计算 $f_{i,j,1}$ 时，经缝合后最后一段可翻转，但 $f_i,j,1$ 还未将最后一段是否翻转的情况考虑进去，但之前的段是否翻转都考虑了，于是 $s_j$ 的计算中 $f_{m,j,1}$ 乘了 $2$。

计算第二步则简单多了
$$
ans=\sum_{j=0}^{m-1}(-1)^js_j(m-j)!
$$

### 容斥的一些特点

（1）可以对排列进行容斥，来去掉 $[1,n]$ 中每个数字只能选不超过 $1$ 次的限制。

[P3349 [ZJOI2016]小星星](https://www.luogu.com.cn/problem/P3349) 

（2）如果贡献的计算只与选中的元素的个数相关的话，可以考虑用 平方 甚至 线性 的 dp 来计算容斥式。

[oiclass P3955 记录数列](..\..\题面\oiclass P3955 记录数列.png) 





