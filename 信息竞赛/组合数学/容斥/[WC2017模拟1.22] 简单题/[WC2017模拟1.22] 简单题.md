### 题目大意

给定 $n,k$ ，求把 $n!$ 拆分成$k$ 个不同的正整数的乘积的方案数。（一种方案的排列仍是一种方案）。答案对 $1000000007$ 取模。

$n≤10000,k≤30$​

时限为 $4s$

解：

设 $k$ 个正整数分别为 $x_i$。

首先可以不管算重，最终答案的方案数中 $x_i$ 互不相同，答案除以 $k!$ 即可。

很明显要对 $n!$​ 质因数分解，设分解后质因数 $p_i$​ 的次数为 $e_i$​​ 个，$n!$​ 分解为 $r$​ 个 $p_i$​。
$$
n! = \prod_{i=1}^{r} p_i^{e_i}
$$


可以想到，两个数相等当且仅当其质因数分解后所有质因数的次数（包括 $0$​ 次）都相等，但只要有一个质因数的次数不同，这两个数就不相等。

所以可知让两个数相等的拆分情况要比让两个数不相等的拆分情况简单，所以可以考虑用容斥解决。

做容斥首先要考虑用什么性质来划分方案数，容易想到用 $\frac{k(k-1)}{2}$ 条性质，其中性质 $A_{(u,v)}$ 代表 $x_u$ 与 $x_v$ 相等。

于是令 $P(\cap A_{{(u,v)}})$​​​ 表示同时满足 $\cap A_{(u,v)}$ 这组性质后 $n!$​​​ 的拆分方案。

但直接套用容斥原理的公式会超时，因为本题过复杂无法用组合数简化公式的计算，直接算相当于要枚举每一组性质，时间复杂度带了一个 $O(2^{k^2})$​​，会超时。

计数的巧妙在于合并同类项，将数值上有关系的一组数之和转化为乘法是降低时间复杂度的方法。

如因为等式带有传递性，所以相当一部分的 $P$​ 实际上都相同， 如 $P(A_{(1,2)}A_{(1,3)}A_{(1,4)})$​ 等于 $P(A_{(1,2)}A_{(1,3)}A_{(1,4)}A_{(2,3)}A_{(2,4)A_{(3,4)}})$​，也等于 $P(A_{(5,6)})A_{(5,7)}A_{(5,8)}$​​。

说明只要 $P$​ 所对应的图的连通情况（各个大小的连通块的数目相同）相同，也不管节点的编号，它们的数值都相同，这给了我们合并同类项的一个途径。

于是接下来需要考虑三步：

1. $k$ 个点的图有多少种连通情况。
2. 每种连通情况下 $P$ 的值。
3. 每种连通情况对应多组性质，其中某一组性质的 $P$ 在容斥公式中是正是负取决于这组性质中有多少个性质（边的个数），我们要考虑的只有每种连通情况下 $+1$ 的数量与 $-1$ 的数量的差值  $delta$ （$-1$ 的多为负，$+1$​ 的多为正）。

则每一种连通情况对容斥公式的贡献为 $delta \times P$。

第一步：

相当于问正整数 $k$​ 有多少种拆分方式，且我们要具体到每一种拆分方式，所以这一步用 $\text{dfs}$ 遍历每种连通情况，$30$ 大概只有 $5000$ 多种拆分方式。

此外还要考虑到每种连通情况有多少种顶点编号分配的方式。

设当前 $k$​ 个点拆分成了，$m$​ 个连通块，每个连通块有 $sz[i]$​ 大小，大小为 $x$​ 的连通块有 $c[x]$​​ 个，​

则顶点分配的方式有 
$$
\frac{k!}{\prod {sz[i]!} \prod{c[x]!}}
$$
种，除上了 $\prod{c[x]!}$​​ 是因为顶点编号分配的方案数与相同大小的连通块之间的次序无关，但与不同大小的连通块之间的次序有关。

第二步：

在一种连通情况，由于 $n!$​ 各个质因子的次数 $e_i$​ 的分配方式都要满足该连通情况，且各个质因子次数的分配相互独立，所以在这种连通情况下的 $P$​​ 等于各个质因子次数的分配方案数之积，于是问题转化为一个质因子的分配方案数如何求。

设 $f[i][j]$​ 表示满足前 $i$​ 个连通块，且当前质因子次数为 $j$​​ 时的分配方案数，则状态转移方程为：
$$
f[i][j] = \left\{
\begin{aligned}
&f[i-1][j] & (j < sz[i])\\
&f[i-1][j] + f[i][j-sz[i]] & (j \geq sz[i])\\
\end{aligned}
\right.
$$
初始条件为 $f[0][0] = 1$​ ，除此之外 $f[i][j] = 0$​。

注意这个 $\text{dp}$ 是可以在正整数拆分时边 $\text{dfs}$ 边完成的。

所以在这一连通情况下（有 $m$​ 个连通块）的 $P$​ 为：
$$
P = \prod_{x=1}^{r} f[m][e_x]
$$
第三步：

这一步最麻烦，涉及到满足某一连通情况下偶数边与奇数边各自的无向图数。

先考虑整个图都是连通的情况下偶数边与奇数边的方案数分别为多少。

设 $f[x]$ 与 $g[x]$ 分别表示顶点数为 $x$ 的连通无向图奇数边与偶数边各自的方案数，t[x] 与 s[x] 分别表示顶点数为 $x$ 的奇数边与偶数边的无向图数。

显然有初始条件 $f[1] = 0$​ 和 $g[1] = 1$​​ ，$t[1] = 0$ 和 $s[1] = 1$。

考虑转移则有：
$$
f[x] = t[x] - \sum_{i=1}^{x-1}C_{x-1}^i(t[i]\times g[x-i] + s[i]\times f[x-i])
$$

$$
g[x] = s[x] - \sum_{i=1}^{x-1}C_{x-1}^i(s[i]\times g[x-i] + t[i]\times f[x-i])
$$



显然有 $t[x] = s[x]\quad (x>1)$​​，但 $t[1] = 0, s[1] = 1$，所以有 （$x>1$​ 时）：
$$
g[x]-f[x] = -(x-1)(g[x-1]-f[x-1])
$$
令 $h[x] = g[x] - f[x]$ 则有：
$$
h[x] = \left\{
\begin{aligned}
&-(x-1)h[x-1] & (x>1)\\
&1 &(x = 1)\\
\end{aligned}
\right.
$$
然后考虑特定连通情况，即整个图分为若干个连通块（假设有 $m$ 个）的情况。

设 $cf[i]$ 与 $cg[i]$ 分别表示在已考虑完前 $i$ 个连通块的情况下奇数边与偶数边的无向图数。

初始条件有 $cf[1] = f[sz[1]]$ 和 $cg[1] = g[sz[1]]$。

状态转移有：
$$
cf[i] = cf[i-1]\times g[sz[i]] + cg[i-1]\times f[sz[i]]
$$

$$
cg[i] = cg[i-1]\times g[sz[i]] + cf[i-1]\times f[sz[i]]
$$

则会发现：

$cg[i] - cf[i] = (cg[i-1]-cf[i-1])h[i]$



令 $ch[i] = cg[i] - cf[i]$​ 则有：
$$
ch[i] = ch[i-1]\times h[i]
$$
综合上述三步可知这种连通情况下对容斥公式的贡献为：
$$
\frac{k!}{\prod {sz[i]!} \prod{c[x]!}} \cdot \prod_{x=1}^{r} f[m][e_x] \cdot \prod_{i=1}^m h[sz[i]]
$$
其中 $h$​ 可以预处理出来。

记得容斥公式算出来后还要除个 $k!$ 才是真正的答案。

于是题就解完了。

































