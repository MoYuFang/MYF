### 矩阵树

保留出度就是根向树，入度就是叶向树。

矩阵树定理的原理是，删掉一个点，使得点数和边数等，然后利用行列式中线性相关则零的性质将有环的情况抹去，留下无环也即树的情况。

正常的矩阵树只删掉一个点，故只能计算一颗树的情形，想要拓展的话，就得从删多几个点去考虑。

在矩阵树定理的分析中，$M$ 矩阵的行对应点，列对应边，当 $M_{ij}$ 在边 $j$ 以 $i$ 为起点时为 $-1$，为终点时为 $1$，否则为 $0$。

计算无向树时用 $L$ 矩阵即 $L=M\cdot M^T$ 即可。

计算根向树时取 $M_{out}$ 为只保留起点的也即让所有 $1$ 为变成 $0$ 的 $M$，则出度 $L$ 矩阵 $L_{out}=M\cdot M_{out}^T$ 可以用来生成根向树。

叶向树的情况类似。

先考虑删多个点的情况，以根向树为例，如果删去点 $i_1,...,i_l$，则对应于将 $L_{out}$ 第 $i_1,...,i_l$ 与第 $i_1,...,i_l$ 列同时删去，后得到的方阵的行列式的绝对值就是以 $i_1,...,i_l$ 为根的根向森林的个数。

### 习题

[P4111 [HEOI2015]小 Z 的房间](https://www.luogu.com.cn/problem/P4111) 矩阵树模板题。

[P2144 [FJOI2007]轮状病毒](https://www.luogu.com.cn/problem/P2144) 矩阵树模板题。

[P6178 【模板】Matrix-Tree 定理](https://www.luogu.com.cn/problem/P6178)

[P6624 [省选联考 2020 A 卷] 作业题](https://www.luogu.com.cn/problem/P6624) 欧拉反演后得出答案为
$$
ans=\sum_{d}\varphi(d)\sum_{T_d}S(T_d)
$$
其中 $T_d$ 表示某生成树的边集，满足这些边的边权为 $d 的倍数，$S(T_d)$ 表示 $T_d$ 所有边权之和。

考虑矩阵树定理处理无向图 $G$，显然行列式中每颗生成树的贡献就是边权之积，如何建立边权之积与边权之和的关系呢？答案是用模 $x^2$ 的生成函数，即将边权 $w_i$ 变成 $(1+w_ix)$，则模 $x^2$ 下某生成树 $T$ 的边权之积就是 $1+(\sum_{w\in T}w)x$，其一次项系数就是边权之和。然后求行列式的时候要用到多项式乘逆，很简单
$$
\frac{1}{a+bx}=\frac{a-bx}{a^2}
$$
这样计算的复杂度为 $O(n^3w)$，其中 $w$ 是最大边权。

考虑一些优化， 在枚举 $d$ 的过程中，先特判一下所有边权为 $d$ 的倍数的边是否能让无向图连通，若不连通就不用计算行列式了，因为此时行列式一定为 $0$。

[CF917D Stranger Trees](https://www.luogu.com.cn/problem/CF917D) 考虑用生成函数，在无向图上，若节点 $u,v$ 在树上不相连，则边权置为 $1$，否则置为 $1+x$，计算行列式时对 $[x^n]$ 取模，时间复杂度为 $O(n^4\log n)$，显然过不去。注意到答案一定是一个 $n-1$ 次多项式，可以使用拉格朗日插值，时间复杂度降为 $O(n^4)$。 

事实上还有 $O(n^3)$ 的做法，考虑用容斥，钦定 $k$ 条边必须选，则形成 $n-k$ 个连通块，设第 $i$ 个连通块的大小为 $a_i$，然后将连通块缩成一个点，无向完全图上与这个点相连的所有边的边权置为 $a_i$，用 $\text{Matrix-Tree}$ 定理可以计算出行列式的值为 $\displaystyle \prod_{i=1}^{n-k}a_ik^{k-2}$，然后可以用 $O(n^3)$ 的 $\text{dp}$ 计算答案。

[hydro.ac_d_nsas_p80](..\..\..\题面\hydro.ac_d_nsas_p80.png) 将红边视为 $x^{-1}$，蓝边视为 $x$，根据矩阵树定理，对(度数矩阵-邻接矩阵)的前 $n-1$ 阶求行列式，会得到一个度数为 $-n$ 至 $n$ 的多项式，其中度数为 $i$ 的项的系数就表示 $蓝边-红边=i$ 的方案数。

具体可以给 $x$ 代入 $2n-2+1$ 个值，算行列式，再插值，复杂度 $O(n^4)$。

为了避免负数次方，可以先将多项式整体乘个 $x^{n-1}$。

